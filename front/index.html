<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Ulaanbaatar Path Finder</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; width: 100vw; }
    
    #config { 
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
      font-family: sans-serif;
    }

    #config label {
      display: block;
      margin-bottom: 5px;
    }

    #config input {
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="config">
    <strong>Algorithms:</strong><br/>
    <label><input type="checkbox" value="bfs" checked> BFS - цэнхэр - <span id="bfs-distance"></span></label>
    <label><input type="checkbox" value="dfs"> DFS - улбар шар - <span id="dfs-distance"></span></label>
    <label><input type="checkbox" value="dijkstra"> Dijkstra - ногоон - <span id="dijkstra-distance"></span></label>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const ubBounds = [[47.88, 106.81], [47.96, 107.01]];

    const map = L.map('map').fitBounds(ubBounds);
    map.setMaxBounds(ubBounds);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const ubRectangle = L.rectangle(ubBounds, {color: "#ff7800", weight: 2, fillOpacity: 0}).addTo(map);

    let start = null, end = null;
    let pathLayers = {}; 
    function requestPath(algo) {
      if (!start || !end) return;

      fetch(`http://localhost:8000/path?start_lat=${start.lat}&start_lon=${start.lng}&end_lat=${end.lat}&end_lon=${end.lng}&algo=${algo}`)
        .then(r => r.json())
        .then(data => {
          if (data.path && data.distance) {
            const coords = data.path.map(p => [p.lat, p.lon]);
            if (pathLayers[algo]) map.removeLayer(pathLayers[algo]);
            let color = 'blue';
            if (algo === 'dfs') color = 'orange';
            if (algo === 'dijkstra') color = 'green';

            pathLayers[algo] = L.polyline(coords, {color: color, weight: 3}).addTo(map);

            if (algo === 'bfs') {
              document.getElementById('bfs-distance').textContent = `${data.distance.toFixed(3)} m`;
            } else if (algo === 'dfs') {
              document.getElementById('dfs-distance').textContent = `${data.distance.toFixed(3)} m`;
            } else {
              document.getElementById('dijkstra-distance').textContent = `${data.distance.toFixed(3)} m`;
            }
          } else {
            alert(`No path found for ${algo}`);
          }
        });
    }

    function updatePaths() {
      const checkedAlgos = Array.from(document.querySelectorAll('#config input[type=checkbox]:checked')).map(cb => cb.value);
      Object.keys(pathLayers).forEach(algo => {
        if (!checkedAlgos.includes(algo)) {
          map.removeLayer(pathLayers[algo]);
          delete pathLayers[algo];
        }
      });
      checkedAlgos.forEach(algo => requestPath(algo));
    }

    map.on('click', e => {
      if (!map.getBounds().contains(e.latlng)) return;

      if (!start) {
        start = e.latlng;
        L.marker(start, {color: 'red'}).addTo(map).bindPopup("Start").openPopup();
      } else if (!end) {
        end = e.latlng;
        L.marker(end, {color: 'green'}).addTo(map).bindPopup("End").openPopup();
        updatePaths();
      } else {
        map.eachLayer(layer => {
          if (layer instanceof L.Marker || (layer instanceof L.Polyline && layer !== ubRectangle)) {
            map.removeLayer(layer);
          }
        });
        start = end = null;
        pathLayers = {};
      }
    });

    document.querySelectorAll('#config input[type=checkbox]').forEach(cb => {
      cb.addEventListener('change', updatePaths);
    });

  </script>
</body>
</html>
